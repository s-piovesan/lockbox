<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Serrure √† Crocheter</title>
  <style>
    body {
      background-color: #1c1c1c;
      color: #fff;
      font-family: 'Segoe UI', sans-serif;
      text-align: center;
      margin: 0;
      padding-top: 50px;
    }
    .lock {
      margin: 0 auto;
      width: 120px;
      height: 160px;
      background: linear-gradient(#555, #222);
      border-radius: 20px;
      position: relative;
      transition: transform 1s ease;
    }
    .lock.open {
      transform: rotateY(60deg);
    }
    .shackle {
      width: 60px;
      height: 60px;
      border: 10px solid #999;
      border-bottom: none;
      border-radius: 60px 60px 0 0;
      position: absolute;
      top: -60px;
      left: 30px;
    }
    .pick-container {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 30px;
    }
    .pick {
      width: 20px;
      height: 80px;
      background: #888;
      border-radius: 5px;
      transition: background 0.3s, transform 0.5s;
    }
    .pick.ok {
      background: limegreen;
      transform: scaleY(1.2);
    }
    .pick.failed {
      background: darkred;
    }
    .hidden { display: none; }

    @keyframes unlock {
      0% { transform: rotateY(0deg); }
      100% { transform: rotateY(60deg); }
    }
  </style>
</head>
<body>
  <h1>üîê Crochetage en cours...</h1>
  <div class="lock" id="lock">
    <div class="shackle"></div>
  </div>
  <div class="pick-container" id="picks"></div>
  <div id="victoryMessage" class="hidden">
    <h2>üéâ Serrure ouverte !</h2>
  </div>

  <script>
    let difficulty = parseInt(new URLSearchParams(window.location.search).get("d")) || 3;
    let victory = false;

    function createPicks(n) {
      const container = document.getElementById("picks");
      for (let i = 0; i < n; i++) {
        const pick = document.createElement("div");
        pick.classList.add("pick");
        pick.id = "pick" + i;
        container.appendChild(pick);
      }
    }

    function update() {
      fetch("/status")
        .then(r => r.json())
        .then(d => {
          if (d.victory && !victory) {
            victory = true;
            document.getElementById("lock").classList.add("open");
            document.getElementById("victoryMessage").classList.remove("hidden");

            // Envoi signal de victoire au serveur
            fetch("/reset", { method: "GET" });

            // Envoyer confirmation au client/parent si n√©cessaire
            setTimeout(() => {
              fetch("/confirm", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ unlocked: true })
              });
            }, 2000);

            return;
          }

          for (let i = 0; i < difficulty; i++) {
            const pick = document.getElementById("pick" + i);
            if (pick) {
              pick.className = "pick " + (d.joysticks[i] ? "ok" : "");
            }
          }
        });
    }

    createPicks(difficulty);
    setInterval(update, 500);
  </script>
</body>
</html>
